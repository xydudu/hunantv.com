window.HN&&window.APE&&(HN.IM=(function(){APE.Config.baseUrl=HN.config.url.js+"APE_JSF";APE.Config.domain="auto";APE.Config.server="push.tazai.com:6969";APE.Config.scripts.push(HN.config.url.js+"lib/ape.core.min.js");var f=new APE.Client(),z={},x,j,n,g,w;f.load({identifier:"honey-im",transport:2,complete:function(A){n=A;n.inDialog=$("#hn-im-dialogbox").length>0;n.inDialog&&(f.loading=e());if(!window.UID){HN.debug("where is the uid? baby");alert("\u6b64\u9875\u6ca1\u6709\u8bbe\u5b9aUID, APE\u4e0d\u80fd\u767b\u5f55\uff0c\u8bf7\u505a\u6b64\u9875\u9762\u7684\u4eba\u6539\u6539\uff01");n.inDialog&&u();return}HN.debug("IM connecting..");c(UID,function(B){HN.debug("IM connect OK");if(n.inDialog){n.request.send("MGQ_IMCHAT",{},true);f.inited&&f.loading.close()}f.connected=true})}});function e(){var C=$("#im-loading"),A=$("#im-loading-img");if(!C.length){var D=$(window),B={height:D.height(),width:D.width(),opacity:0.5};C=$("<div />").attr("id","im-loading").appendTo("body");A=$("<img />").attr({id:"im-loading-img",src:CSSURL+"ui/mangoq/2010v1/images/ico/loading2.gif"}).appendTo("body");C.css(B).show()}return{close:function(){C.hide();A.hide()},show:function(){C.show();A.show()}}}function c(B,A){if(!n){return}n.start({uin:""+B,samkey:HN.cookie.get("samkey")});f.onRaw("LOGIN",function(C){});f.onRaw("IDENT",function(C){A(C.data.user)})}f.onRaw("ERR",function(A){HN.debug("err");HN.debug(A)});f.onRaw("MGQ_ADDCHAT",function(A){HN.debug("get ADD");window.location.hash="cuid="+A.data.uin});f.onRaw("MGQ_CHATLEFT",function(A){HN.cookie.remove("imopen","","/");g=null});f.onRaw("MGQ_MSG",function(C){var J=C.data.from.properties.uin,B=C.data.msg,D=function(O,N){var K=[],L=0,M=window.document.title;(function(){if(J==j&&$("body").attr("id")=="focused"){window.document.title=M;return}window.document.title=L%2?M:"["+O+" \u6765\u6d88\u606f\u4e86]";L++;setTimeout(arguments.callee,500)})();(!N.length)&&(K.push(z[J]),N=x.insertOne(K));i(N,J)};if(n.inDialog){var F=l(J),H=$("#user-"+J);F?(D(F,H),a(J,{msg:decodeURIComponent(B),ctime:m(C.time),uid:J,cuid:J})):b(J,function(K){z[J]=K.chat_user;z[J].chat_msg=K.chat_msg;z[J].relation=K.relation;z[J].relation2=K.relation2;!z[J].inited&&a(J,K.chat_msg);z[J].inited=1;D(K.chat_user.nickname,H)},true)}else{var G=$("#im-msg-num"),A=G.find("a"),I=+A.text(),E=I?I+1:1;A.html(E);G.show()}});function l(A){if(z[A]&&z[A].nickname){return z[A].nickname}else{return false}}function i(C,A){var D=0,B=C.find(".chat-frame-users-face img");(function(){if(A==j){B.css("margin",0);return}B.css("marginRight",(D%3)-1);B.css("marginTop",(D%3)==1?1:0);D++;setTimeout(arguments.callee,150)})()}function d(C,A){var E=$("#user-list-box"),F=[],B=[];if(C.length){E.html(HN.tmpl("userlisttmpl",{users:C,shakeID:B})).unbind("click").click(HN.delegate({"div.chat-frame-users-default, div.chat-frame-users-name>a, div.chat-frame-users-face img":function(){var G=$(this).attr("id").split("-")[1];p(G);return false}}));while(B.length){var D=B.shift();i($("#user-"+D),D)}}return{insertOne:function(H){var G=HN.tmpl("userlisttmpl",{users:H});E.append(G);return $("#user-"+H[0].uid)}}}function p(D){var C=$("#user-"+D),B=C.parent().find(".chat-frame-users-active");C.data("dot",C.find(".chat-frame-users-dot>img").attr("src"));B.each(function(E){var F=$(this);F.data("dot")&&A(F,"chat-frame-users-default",F.data("dot"),CSSURL+"ui/mangoq/2010v1/images/ico/action_del_default.gif")});A(C,"chat-frame-users-active",CSSURL+"ui/mangoq/2010v1/images/ico/y_white.gif",CSSURL+"ui/mangoq/2010v1/images/ico/action_del_active.gif");j=D;$("#cuid").val(D);o(D);k(D);function A(H,G,F,E){H.attr("className",G);H.find(".chat-frame-users-dot>img").attr("src",F);H.find(".chat-frame-users-del>img").attr("src",E)}}function o(B){var A=$("#user-info"),C=function(D){if(D.relation.is_black){q(B);$("#im-form").hide()}else{$("#im-isblock-box").hide();$("#im-form").show()}A.html(HN.tmpl("userinfotmpl",D));!D.inited&&a(B,D.chat_msg);D.inited=1;!A.status&&A.find("img[over]").hover(function(){this.src=[$(this).attr("over"),$(this).attr("over",this.src)][0]});A.status=true};if(z[B]){C(z[B])}else{b(B,function(D){z[B]=D.chat_user;z[B].chat_msg=D.chat_msg;z[B].relation=D.relation;C(z[B])})}}function b(B,A,C){f.loading&&f.loading.show();C&&f.loading.close();HN.ajax.get(BASEURL+"chat/chat/chat_msg",{cuid:B},function(D){f.loading&&f.loading.close();A(D)},function(){})}function v(A){var D=$("#im-form");D.html(HN.tmpl("chatformtmpl",{cuid:A}));var E=$("#im-submit"),C=$("#random-msg"),B=$("#message");E.hover(function(){this.src=[$(this).attr("over"),$(this).attr("over",this.src)][0]}).click(s);C.click(function(){B.val(RANDOMMSG[parseInt(HN.random(0,RANDOMMSG.length-1))])});$("#face-trigger").click(y);document.onkeydown=function(F){var G=window.event?window.event:F;if(G.keyCode==13){E.trigger("click");return false}}}function y(){var C=$(this),A=18,B=$("#im-face-box");if(!B.length){B=$("<span />").attr({id:"im-face-box"}).css("marginRight",10).insertBefore(C);while(A>0){B.append('<img src="'+CSSURL+"ui/mangoq/2010v1/images/ico/face_"+A+'.jpg" title="face_'+A+'" border="0" />');A--}}else{B.remove()}B.children("img").click(function(){B.remove();var K=document.getElementById("message"),D=h(K),L=" {"+this.title+"} ";var H,E,J,F,G,I,M;t(K,D);if(K.setSelectionRange){H=K.value;E=H.substring(0,D.start)+L+H.substring(D.end);G=I=D.start+L.length;M=K.scrollTop;K.value=E;if(K.scrollTop!=M){K.scrollTop=M}K.setSelectionRange(G,I)}else{if(K.createTextRange){F=document.selection.createRange();F.text=L;F.setEndPoint("StartToEnd",F);F.select()}}})}function t(B,A){if(!A){alert("You must get cursor position first.")}if(B.setSelectionRange){B.focus();B.setSelectionRange(A.start,A.end)}else{if(B.createTextRange){var C=B.createTextRange();if(B.value.length===A.start){C.collapse(false);C.select()}else{C.moveToBookmark(A.bookmark);C.select()}}}}function h(B){var A={text:"",start:0,end:0};B.focus();if(B.setSelectionRange){A.start=B.selectionStart;A.end=B.selectionEnd;A.text=(A.start!=A.end)?B.value.substring(A.start,A.end):""}else{if(document.selection){var C,D=document.selection.createRange(),E=document.body.createTextRange();E.moveToElementText(B);A.text=D.text;A.bookmark=D.getBookmark();for(C=0;E.compareEndPoints("StartToStart",D)<0&&D.moveStart("character",-1)!==0;C++){if(B.value.charAt(C)=="\n"){C++}}A.start=C;A.end=A.text.length+A.start}}return A}function s(){var C=$("#message"),B=$("#cuid").val(),A=C.val();if(HN.trim(A)===""){HN.debug("\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a");C.shakeElem();return false}if(!+B){HN.debug("where is cuid?");return false}if(!n){HN.debug("ape not ready!");return false}C.val("");a(B,{msg:A,ctime:m(),uid:UID,cuid:B});if(z[B]&&z[B].relation2&&z[B].relation2.is_black){return false}n.request.send("MGQ_SEND",{uin:""+B,msg:A},true);return false}function m(B){var H;if(B){var C=new Date(B*1000),G=C.getFullYear(),D=C.getMonth()+1,F=C.getDate(),E=C.getHours(),A=C.getMinutes(),I=C.getSeconds();H=E+":"+A+":"+I}else{H=Date().match(/\d{1,2}:\d{1,2}:\d{1,2}/)[0]}return H}function a(A,C){var B=['<div class="chat-frame-inputs-name-[%=cls%]">[%=who%]  [%=ctime%]</div>',"<span>[%=msg%]</span>"].join(""),E=[],D=document.getElementById("msg-list");if(C.msg){E.push(C)}else{E=C}inbox=k(A);$.each(E,function(G,F){F.cls=(A==F.cuid)?"a":"b";F.msg=r(decodeURIComponent(F.msg));F.who=(UID==F.uid)?"\u6211":l(F.uid);inbox.append(HN.tmpl(B,F));D.scrollTop=D.scrollHeight})}function r(A){A=A.replace(/\{face_([0-9]|1[0-8])\}/g,"<img onerror=\"this.src='"+CSSURL+'ui/mangoq/2010v1/images/ico/face_2.jpg\';" src="'+CSSURL+'ui/mangoq/2010v1/images/ico/face_$1.jpg"/>');return A}function k(A){var B=document.getElementById("msg-list"),C=$("#msg-list-"+A);if(!C.length){C=$('<div class="chat-frame-content" id="msg-list-'+A+'"></div>').appendTo("#msg-list")}C.hide();if(j==A){$(".chat-frame-content").hide();C.show();B.scrollTop=B.scrollHeight}return C}function q(A){var B=$("#im-isblock-box");B.find("input").attr("className","hn-action-disblock-im c-"+A);B.show()}function u(){try{g.close()}catch(A){window.close()}HN.cookie.remove("imopen","","/");g=null}$(window).bind("beforeunload",function(){HN.cookie.remove("imopen","","/");g=null});return{init:function(A,B){if($("body").attr("id")!="focused"&&HN.cookie.get("imopen")){var C=0,D=window.document.title;(function(){if($("body").attr("id")=="focused"){window.document.title=D;return}window.document.title=C%2?D:"\u53ef\u4ee5\u804a\u5929\u5566\uff0c\u5feb\u6765\u5feb\u6765\uff01\uff01";C++;setTimeout(arguments.callee,500)})()}self.focus();v(A);HN.ajax.get(BASEURL+"chat/chat/pull",{uid:UID,cuid:A},function(E){if(HN.isString(E.user.avatar_key)&&E.user.avatar_key!=""){z[A]=E.chat_user;z[A].chat_msg=E.chat_msg;z[A].relation=E.relation;z[A].relation2=E.relation2;x=d(E.user_list,A);p(A)}else{HN.debug("\u6ca1\u5934\u50cf")}f.connected&&f.loading&&f.loading.close();HN.cookie.set("imopen",1,"","","/")},function(){HN.debug("\u53d6\u6570\u636e\u65f6\u51fa\u9519\uff01")})},updateUserInfo:function(A){b(A,function(B){z[A].relation=B.relation;z[A].relation2=B.relation2})},blockUser:function(A){q(A);$("#im-form").hide();z[A].relation.is_black=true},disblockUser:function(A){$("#im-isblock-box").hide();$("#im-form").show();z[A].relation.is_black=false},removeUser:function(A){if(j==A){$("div.chat-frame-users-default").length?window.location.hash="cuid="+$("div.chat-frame-users-default").attr("id").split("-")[1]:u()}$("#user-"+A).remove()},open:function(){if(!n){alert("\u4f60\u8fd8\u6ca1\u767b\u5f55\u5230\u804a\u5929\u7cfb\u7edf\u4e2d\uff0c\u8bf7\u7a0d\u7b49\uff01\uff01\uff01");return false}var B=this.href,A=function(E,D){var F=window.open(E,D,"height=500, width=600, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=yes");return F};if(HN.cookie.get("imopen")){n.request.send("MGQ_ADDCHAT",{uin:B.split("=")[1]},true)}else{try{g.location=this.href}catch(C){g=A(B,this.target)}window.focus&&g.focus()}return false},close:u}})());
//10/12/29 
